#!/bin/bash
ROOT_PWD=${PWD}

rm app.tar.gz
rm -rf ${ROOT_PWD}/out
mkdir -p ${ROOT_PWD}/out

cd rails-webapp
docker build -t artifactory.roving.com/social/rails_builder:${VERSION} .

docker run -v ${ROOT_PWD}/out:/host artifactory.roving.com/social/rails_builder:${VERSION} cp -r /usr/local/lib/ruby/gems/2.1.0/ /host
docker run -v ${ROOT_PWD}/out:/host artifactory.roving.com/social/rails_builder:${VERSION} cp -r /opt/cc/apps/rails_example/ /host

cd ..
tar -czf app.tar.gz --directory=./out 2.1.0 rails_example
rm -rf ${ROOT_PWD}/out
